#!/bin/sh
#
#  $Id: make-postfix.spec,v 1.16 2001/01/19 20:59:23 root Exp $
#

SUFFIX=
REQUIRES=
BUILDREQUIRES=
DISTRIBUTION_PREREQ=
DISTRIBUTION='Unknown Linux Distribution'

# RedHat 6.2 and later include LDAP support, earlier versions don't
# For this reason LDAP support is not compiled by default

echo ""
echo "Generating Postfix spec file: ../SPECS/postfix.spec"
if [ "$POSTFIX_LDAP" = 1 ]; then
    echo "  adding LDAP  support to spec file"
    SUFFIX="${SUFFIX}+ldap"
fi
if [ "$POSTFIX_PCRE" = 1 ]; then
    echo "  adding PCRE  support to spec file"
    SUFFIX="${SUFFIX}+pcre"
fi
if [ "$POSTFIX_MYSQL" = 1 ]; then
    echo "  adding MySQL support to spec file"
    SUFFIX="${SUFFIX}+mysql"
fi
if [ "$POSTFIX_SASL" = 1 ]; then
    echo "  adding SASL  support to spec file"
    SUFFIX="${SUFFIX}+sasl"
fi

# rh7 db3 crap - this is rather ugly
if [ `rpm -q redhat-release` ]; then
    # We are running RedHat Linux
    # check for RedHat 7 and change Requires for new db3 if necessary
    A=`rpm -q redhat-release | grep -q 7; echo $?`
    if [ "$A" = 0 ]; then
        REQUIRES="Requires: db3"
        BUILDREQUIRES="BuildRequires: db3, db3-devel"
        DISTRIBUTION_PREREQ=', /etc/init.d, /sbin/service'
    fi
    DISTRIBUTION=`rpm -q redhat-release` 
fi

# ensure if undefined the value is 0
if [ -z "$POSTFIX_LDAP" ]; then
    POSTFIX_LDAP=0
fi
if [ -z "$POSTFIX_MYSQL" ]; then
    POSTFIX_MYSQL=0
fi
if [ -z "$POSTFIX_PCRE" ]; then
    POSTFIX_PCRE=0
fi
if [ -z "$POSTFIX_SASL" ]; then
    POSTFIX_SASL=0
fi

# Remove leading '+' from package suffix (if exists)
SUFFIX=`echo "${SUFFIX}" | sed -e 's;^\+;;'`

cat > ../SPECS/postfix.spec <<EOF
##############################################################################
#
# W A R N I N G -- DO NOT EDIT THIS FILE -- W A R N I N G
#
# It is generated automatically from postfix.spec.in in the SOURCES directory.
#
EOF
sed "
s!__DISTRIBUTION_PREREQ__!$DISTRIBUTION_PREREQ!g
s!__DISTRIBUTION__!$DISTRIBUTION!g

s!__SMTPD_MULTILINE_GREETING__!$POSTFIX_SMTPD_MULTILINE_GREETING!g
s!__SAFE_MYNETWORKS__!$POSTFIX_SAFE_MYNETWORKS!g
s!__BROKEN_AUTH__!$POSTFIX_BROKEN_AUTH!g

s!__REQUIRES__!$REQUIRES!g
s!__BUILDREQUIRES__!$BUILDREQUIRES!g

s!__SUFFIX__!$SUFFIX!g

s!__LDAP__!$POSTFIX_LDAP!g
s!__MYSQL__!$POSTFIX_MYSQL!g
s!__PCRE__!$POSTFIX_PCRE!g
s!__SASL__!$POSTFIX_SASL!g
" postfix.spec.in >> ../SPECS/postfix.spec

# end of make-postfix.spec
