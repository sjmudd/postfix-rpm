##############################################################################
# $Id: postfix.spec.in,v 2.14 2000/11/25 17:40:13 root Exp $
#
# Spec file for package postfix designed to be built on RedHat Linux.
# Please send bugfixes and comments to the packager.
##############################################################################

Name: postfix
Summary: Postfix Mail Transport Agent
Group: System Environment/Daemons
URL: http://www.postfix.org
Copyright: IBM Public License -- see LICENSE for details
#This line not used as on redhat-release-6.2-1 I don't have this directory
#PreReq: /sbin/chkconfig, /etc/init.d
PreReq: /sbin/chkconfig
Provides: MTA smtpd smtpdaemon
Conflicts: sendmail
Version: 20001121
Release: 1
Packager: Simon J Mudd <sjmudd@pobox.com> but see description below
Vendor: None -- see packager
Distribution: Experimental
Source0: ftp://ftp.porcupine.org/mirrors/postfix-release/experimental/snapshot-20001121.tar.gz
Source1: postfix-README_rpm.txt
Source2: postfix-README_maildrop_security.txt
Source3: postfix-etc-rc.d-init.d-postfix
Source4: postfix-cron.daily.sh
Source5: postfix-aliases
Source6: postfix-chroot-setup.awk
Patch1:  postfix-config.patch
Patch2:  postfix-chroot_chk.patch
###Patch3:  postfix-makedefs.patch2  ### shouldn't be necessary any more
#  ** Patch99 is applied only on builds on my machines **
Patch99: postfix-smtpd_reply_multiline.patch
BuildRoot: /var/tmp/%{name}-%{version}-root


%description
Postfix, see http://www.postfix.org, aims to be an alternative to the
widely-used sendmail program, which is responsible for 70 percent of
all e-mail delivered on the Internet.

Although IBM supported the Postfix development, it abstains from control
over its evolution.  The goal is to have Postfix installed on as many
systems as possible.  To this end, the software is given away with no
strings attached, so that it can evolve with input from and under control
of its users.

Be sure to read http://www.moongroup.com/postfix-faq/c22.html which
covers steps which should be taken prior to and after the installation
of Postfix.  Note this faq this is rather out of date.

The binary and source rpms I produce are currently stored on
	http://www.pobox.com/~sjmudd/postfix

Binary RPMS for alpha and S/390-Linux architectures were built by
Klaus Jaehne <klaus.jaehne@to.com>.  Please contact him for information
related to these platforms.


%define setupdir %{name}-%{version}

%define config_directory /etc/postfix
%define daemon_directory /usr/libexec/postfix
%define command_directory /usr/sbin
%define queue_directory /var/spool/postfix
%define newaliases_path /usr/bin/newaliases

%define mailq_path /usr/bin/mailq
%define rmail_path /usr/bin/rmail
# We need a uid and gid for postfix's exclusive use
# Redhat's mail group isn't unique!
%define uid 89
%define gid 89

%define init_directory /etc/rc.d/init.d
%define sendmail_path /usr/sbin/sendmail
%define cron_directory /etc/cron.daily

%define whinge logger -p mail.info -t postfix/rpm


%prep
umask 022

%setup -q -n snapshot-%{version}
# setup master.cf to be chrooted
mv conf/master.cf conf/master.cf-nochroot
awk -f ${RPM_SOURCE_DIR}/postfix-chroot-setup.awk < conf/master.cf-nochroot > conf/master.cf
%patch1 -p1 -b .config
%patch2 -p1 -b .chk
###patch3 -p1 -b .old     shouldn't be needed

# apply this patch ONLY if built on my machines
if [ `hostname`="phoenix.ea4els.ampr.org" -o \
     `hostname`="www2.alltrading.es" ]; then
%patch99 -p1 -b .multiline
fi

# Copy README files allowing us to just go %doc below, and have rpm(1)
# automatically tuck it in alongside the READMEs and COPYRIGHTs.
cp ${RPM_SOURCE_DIR}/postfix-README_rpm.txt README_rpm.txt
cp ${RPM_SOURCE_DIR}/postfix-README_maildrop_security.txt \
	README_maildrop_security.txt

%build

umask 022
make tidy # shouldn't be necessary
########################################################
#                CHOOSE ONE BUILD OPTION HERE          #
########################################################
# This is to build with AUTH support : see SASL_README
# make DEBUG="" OPT="$RPM_OPT_FLAGS" CCARGS=-DSASL
#
############# plain vanilla postfix build ##############
make DEBUG="" OPT="$RPM_OPT_FLAGS"


%pre

# If the user "postfix" isn't in passwd, but the UID I like to use _is_, then
# don't try to find a free UID, just scream and leap...err...shriek and die.
die(){ %whinge "$*"; exit 1; }

# Add the postfix group if not found
grep -q ^postfix: /etc/group || {
    groupadd -g %{gid} -r postfix || die \
            'gid collision, aborting install' \
	    'either add "postfix" group or delete the group using GID %{gid}'
    %whinge "Adding postfix to /etc/group."
}

# Add the postfix user if not found
grep -q ^postfix: /etc/passwd || {
    grep -q "^.*:.*:%{uid}:" /etc/passwd && die \
          'uid collision, aborting install' \
          'either add "postfix" user or delete the user using UID %{uid}'
    %whinge "Adding postfix to /etc/passwd."
    useradd -d %{queue_directory} -s /bin/true -g postfix -M -r -u %{uid} postfix
}


%install
umask 022
/bin/rm -rf ${RPM_BUILD_ROOT}
mkdir -p ${RPM_BUILD_ROOT}

strip -R .comment bin/* libexec/*

# WARNING: don't change the number of blank lines below - INSTALL.sh depends
# on it to work correctly
sh INSTALL.sh <<EOF 
${RPM_BUILD_ROOT}

%{config_directory}
%{daemon_directory}
%{command_directory}
%{queue_directory}
%{sendmail_path}
%{newaliases_path}
%{mailq_path}


%{_mandir}
EOF

# Change the default directory for alias_maps and alias_database
# to %{config_directory}
bin/postconf -c ${RPM_BUILD_ROOT}%{config_directory} -e \
	"alias_maps = hash:%{config_directory}/aliases" \
	"alias_database = hash:%{config_directory}/aliases" \
|| exit 1 

# This installs into the /etc/rc.d/init.d directory
mkdir -p ${RPM_BUILD_ROOT}%{init_directory}
install -c ${RPM_SOURCE_DIR}/postfix-etc-rc.d-init.d-postfix \
                  ${RPM_BUILD_ROOT}%{init_directory}/postfix

# Copy the Linux chroot setup script to %{config_directory} so
# we can use it to build the chroot environment during the install
cp examples/chroot-setup/LINUX2 \
		${RPM_BUILD_ROOT}%{config_directory}/chroot-setup-LINUX2
chmod u=rx ${RPM_BUILD_ROOT}%{config_directory}/chroot-setup-LINUX2

# This is the /etc/cron.daily directory
mkdir -p ${RPM_BUILD_ROOT}%{cron_directory}

install -c ${RPM_SOURCE_DIR}/postfix-cron.daily.sh ${RPM_BUILD_ROOT}%{cron_directory}/postfix
install -c auxiliary/rmail/rmail ${RPM_BUILD_ROOT}%{rmail_path}

gzip -9f ${RPM_BUILD_ROOT}%{_mandir}/man{1,5,8}/* ||:

#
# copy new aliases files and build the aliases.db (ghost) file
#
cp -f  ${RPM_SOURCE_DIR}/postfix-aliases ${RPM_BUILD_ROOT}%{config_directory}/aliases
chmod 644 ${RPM_BUILD_ROOT}%{config_directory}/aliases
${RPM_BUILD_ROOT}/%{command_directory}/postalias -c ${RPM_BUILD_ROOT}/%{config_directory} ${RPM_BUILD_ROOT}/%{config_directory}/aliases


##############################################################################
# The post script executes after the package has been installed.  Here
# we put things that invoke files we just installed, and populate the
# directories we've created with local-dependent files.
%post

umask 022

/sbin/chkconfig --add postfix
# setups missing directory structures
%{command_directory}/postfix check
# setup chroot structure
%{config_directory}/chroot-setup-LINUX2

%preun
umask 022

if [ "$1" = 0 ]; then
    %{command_directory}/postfix stop
    /sbin/chkconfig --del postfix                    

    userdel postfix || : %whinge "WARNING: failed to remove user postfix"
    groupdel postfix || : %whinge "WARNING: failed to remove group postfix"
    # remove chroot jail when uninstalling the package
    for i in /etc/localtime /usr/lib/zoneinfo/localtime \
		/etc/host.conf /etc/resolv.conf /etc/nsswitch.conf \
		/etc/hosts /etc/passwd /etc/services \
		/lib/libnss_* /lib/libresolv*; do
        test -f %{queue_directory}$i && rm -f %{queue_directory}$i
    done
fi

%postun

if [ "$1" != 0 ]; then
    (%{command_directory}/postfix stop && sleep 2 && %{command_directory}/postfix start) || true
fi

%clean
rm -rf ${RPM_BUILD_ROOT}


%files
%defattr(-, root, root)
%verify(not md5 size mtime) %config %dir %{config_directory}
%attr(0755, root, root) %config %{config_directory}/postfix-script
%attr(0644, root, root) %verify(not md5 size mtime) %config %{config_directory}/main.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config %{config_directory}/master.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config %{config_directory}/install.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config(noreplace) %{config_directory}/aliases
%attr(0644, root, root) %verify(not md5 size mtime) %ghost             %{config_directory}/aliases.db

%attr(0755, root, root) %{init_directory}/postfix
%attr(-, postfix, root) %verify(not md5 size mtime) %{queue_directory}
%attr(0755, root, root) %{cron_directory}/postfix

%doc 0README
%doc BEWARE
%doc COMPATIBILITY
%doc DEBUG_README
%doc ETRN_README
%doc FILTER_README
%doc HISTORY
%doc INSTALL
%doc INSTALL.sh
%doc LDAP_README
%doc LICENSE
%doc LMTP_README
%doc MACOSX_README
%doc MYSQL_README
%doc PCRE_README
%doc PORTING
%doc RELEASE_NOTES
%doc RESTRICTION_CLASS
%doc SASL_README 
%doc TODO
%doc ULTRIX_README
%doc UUCP_README

%doc README_rpm.txt README_maildrop_security.txt

%doc conf
%doc html

%{config_directory}/chroot-setup-LINUX2

%{daemon_directory}/bounce
%{daemon_directory}/cleanup
%{daemon_directory}/error
%{daemon_directory}/flush
%{daemon_directory}/lmtp
%{daemon_directory}/local
%{daemon_directory}/master
%{daemon_directory}/nqmgr
%{daemon_directory}/pickup
%{daemon_directory}/pipe
%{daemon_directory}/qmgr
%{daemon_directory}/showq
%{daemon_directory}/smtp
%{daemon_directory}/smtpd
%{daemon_directory}/spawn
%{daemon_directory}/trivial-rewrite

%{command_directory}/postalias
%{command_directory}/postcat
%{command_directory}/postconf
%{command_directory}/postdrop
%{command_directory}/postfix
%{command_directory}/postkick
%{command_directory}/postlock
%{command_directory}/postlog
%{command_directory}/postmap
%{command_directory}/postsuper

%{sendmail_path}
%{mailq_path}
%{newaliases_path}
%attr(0755, root, root) %{rmail_path}

%{_mandir}/*/*

##############################################################################
# List of changes made to this package.
#
# Old changelog from Tue Dec 15 1998 - Sun Nov 07 has been removed.
# This included changes and suggestions from:
#
#	Lars Hecking <lhecking@nmrc.ucc.ie> 
#	John A. Martin <jam@jamux.com>
#	Chuck Mead <chuck@moongroup.com>
#	Simon J Mudd <sjmudd@pobox.com>
#	Matt Shibla <mshibla@iname.com>
#	Bennett Todd <bet@mordor.net>

%changelog
* Thu Nov 23 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001121-2,
  didn't like chroot jail setup in -1, so now I use the example script
  to build the jail on package installation

- snapshot-20001121-1, makedefs should be fixed (but can't check)
  chroot jail now built on postfix start (from /etc/rc.d/init.d/postfix)
  change invocation of INSTALL.sh when installing into ${BUILD_ROOT}

* Tue Nov 07 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001030-2, add chkconfig postfix to /etc/cron.daily/postfix
  fix Wietse's makedefs so this builds on rh6.x and rh7.
  checked with Patrick Reich <dminor@adelade.org>

* Wed Nov 01 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001030-1, need to refix patch for RedHat 7 which 
  I don't yet have installed on my machine.

* Fri Oct 27 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-6, include patch so will build on RedHat 7,
  provided by Jim Drash <jdrash@one.net>
                    
* Sat Oct 14 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-5, include lmtp, nqmgr, spawn in %files section

* Thu Oct 12 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-4, fix chroot awk script which was wrong

* Thu Oct 12 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-3, changes url shown for my packages.

* Sun Oct 08 2000 Simon Mudd <sjmudd@pobox.com>
- built for snapshot-20001005-2, tidying up and taking in _some_
  of the stuff I've seen on one of redhat's postfix spec files.
  Also corrected the multiline patch.

* Sun Jun 04 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl08

* Sun Apr 15 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl07

* Fri Mar 30 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl06

* Fri Mar 10 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl05

* Tue Feb 01 2000 Simon Mudd <sjmudd@pobox.com>
- include the patch which optionally delays check_msg_size()

* Mon Jan 31 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl04

* Fri Jan 28 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl03
- add warning option (which is not enabled by default on standard postfix
  config)
- add comments of possible builders of binary s390 and alpha packages

* Thu Jan 13 2000 Tim Powers <timp@redhat.com>
- removing the whinge stuff from the pre and post sections to meet Red Hat
	policy
- quiet setup 
- built for Powertools 6.2

* Thu Jan 13 2000 Simon Mudd <sjmudd@pobox.com>
- fix the postalias command which needed the '-c' option
  specified.  (Edward S. Marshall <emarshal@logic.net>)

- fix the rpm-3.x problem with defines not being commented out
  and comment that part of the spec file so that I don't get
  caught again. (It works on my platform with rpm-2.x!)

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- update to work with postfix-19991231-pl02

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- update to work with postfix-19991231-pl01
- and the ghost parameter for aliases.db

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- Fix BEWARE problem in doc
- change man page compression to work on required files

* Fri Dec 24 1999 Simon Mudd <sjmudd@pobox.com>
- update for 19991223 snapshot
- setup the alias_maps and alias_database parameters correctly
- rebuild aliases on install (should fix this to only do this if
  required)
- fix INSTALL.sh which didn't quite work

* Thu Dec 23 1999 Simon Mudd <sjmudd@pobox.com>
- modified the aliases file somewhat.
- re-enabled the whinging after ensuring that output will NOT go to
  stderr, but only syslog.

* Wed Dec 22 1999 Chuck Mead <chuck@moongroup.com>
- added an aliases file per discussions with Tim Powers

* Wed Dec 22 1999 Tim Powers <timp@redhat.com>
- changed group so that it's a valid Red Hat group
- commented out the whinge stuff in the %pre and %post sections to conform
	with Red Hat policy
- changed BuildRoot to be in /var/tmp
- gzip man pages
- changed %{manpath} reference in %files section so that this package doesn't
	claim ownership of /usr/man
- commented out the Patch99 stuff since we don't need it

* Fri Dec 17 1999 Simon J Mudd <sjmudd@pobox.com>
  [19991216-1]: update for new snapshot

* Mon Dec 13 1999 Simon J Mudd <sjmudd@pobox.com>
  [19991126-1]: update for new snapshot

* Sat Dec 03 1999 Simon J Mudd <sjmudd@pobox.com>
  [19991126-1]: update for new snapshot

* Fri Nov 26 1999 Simon J Mudd <sjmudd@pobox.com>
  [19991123-4]: /etc/cron.daily/postfix was installed as well as a crontab
                - remove the crontab entry as this isn't necessary
  [19991123-3]: add a small delay between postfix stop && postfix start
  [19991123-2]: Wietse's rbl code needed, patching - include the patch

* Tue Nov 23 1999 Simon J Mudd <sjmudd@pobox.com>
  [19991123-1]: try the snapshot which looks nice (?)

* Mon Nov 22 1999 Simon J Mudd <sjmudd@pobox.com>
  [19990906-pl07-1]: patch against pl07

* Thu Nov 17 1999 Simon J Mudd <sjmudd@pobox.com>
  [19990906-pl06-2]: tidy up spec file and include rmail
