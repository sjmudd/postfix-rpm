##############################################################################
#
# $Id: postfix.spec.in,v 2.44 2001/01/04 21:41:40 root Exp $
#
# File used to generate the different spec files, used to build the postfix
# package on RedHat Linux.
#
# Please send bugfixes and comments to the packager.
##############################################################################

Name: postfix
Summary: Postfix Mail Transport Agent
Group: System Environment/Daemons
URL: http://www.postfix.org
Copyright: IBM Public License
PreReq: /sbin/chkconfig__DISTRIBUTION_PREREQ__
Provides: MTA smtpd smtpdaemon
Conflicts: sendmail
Version: 20001217
Release: 7__POSTFIX_SUFFIX__
Packager: Simon J Mudd <sjmudd@pobox.com>
Vendor: None -- Built under __DISTRIBUTION__
Distribution: Experimental
Source0: ftp://ftp.porcupine.org/mirrors/postfix-release/experimental/snapshot-%{version}.tar.gz
Source1: postfix-README_rpm.txt
Source2: postfix-README_maildrop_security.txt
Source3: postfix-etc-rc.d-init.d-postfix
Source4: postfix-etc-cron.daily-postfix
Source5: postfix-aliases
Source6: postfix-chroot-setup.awk
Source7: postfix-RPM-TODO-list
Source8: postfix.spec.in
Source9: make-postfix.spec
Patch1:  postfix-config.patch
Patch2:  postfix-chroot_chk.patch
# required to install smtp-sink and smtp-source
Patch3:  postfix-INSTALL.sh.patch
#
# Optional patches - set the appropriate environment variables to include
#                    them when building the package
#
# applied if POSTFIX_BROKEN_AUTH=1
Patch97: postfix-broken_auth.patch
# applied if POSTFIX_SAFE_MYNETWORKS=1
Patch98: postfix-safe_mynetworks.patch
# applied if POSTFIX_SMTPD_MULTILINE_GREETING=1
Patch99: postfix-smtpd_multiline_greeting.patch

BuildRoot: %{_tmppath}/%{name}-%{version}-root

# Requires for different packages - added automatically
__POSTFIX_REQUIRES__
# BuildRequires for different packages - added automatically
__POSTFIX_BUILDREQUIRES__


%description
Postfix aims to be an alternative to the widely-used sendmail program,
which is responsible for 70 percent of all e-mail delivered on the
Internet.

Although IBM supported the Postfix development, it abstains from control
over its evolution.  The goal is to have Postfix installed on as many
systems as possible.  To this end, the software is given away with no
strings attached, so that it can evolve with input from and under control
of its users.

Be sure to read http://www.moongroup.com/postfix-faq/c22.html which
covers steps which should be taken prior to and after the installation
of Postfix.  Note this faq this is rather out of date.

The binary and source rpms I produce are currently stored on
	http://www.pobox.com/~sjmudd/postfix

Binary RPMS for alpha and S/390-Linux architectures were built by
Klaus Jaehne <klaus.jaehne@to.com>.
Please contact him for information related to these platforms.

I have received reports that this package builds on the sparc platform
too. If anyone want to provide binary rpms please let me know.


%define setupdir %{name}-%{version}

%define config_directory /etc/postfix
%define daemon_directory /usr/libexec/postfix
%define command_directory /usr/sbin
%define queue_directory /var/spool/postfix
%define newaliases_path /usr/bin/newaliases

%define mailq_path /usr/bin/mailq
%define rmail_path /usr/bin/rmail
# We need a uid and gid for postfix's exclusive use
# Redhat's mail group isn't unique!
%define uid 89
%define gid 89

%define init_directory /etc/rc.d/init.d
%define sendmail_path /usr/sbin/sendmail
%define cron_directory /etc/cron.daily

%define whinge logger -p mail.info -t postfix/rpm

%prep

# warn before we start if we aren't root
if [ `id -u` != "0" ]; then
    echo "ERROR: Not building postfix package as the superuser"
    echo "ERROR: You MUST be the superuser to build the postfix package"
    echo "ERROR: as part of the package build process requires superuser privileges"
    echo ""
    echo "Please su - root and try again"
    exit 1
fi

umask 022
%setup -q -n snapshot-%{version}

# setup master.cf to be chrooted
mv conf/master.cf conf/master.cf-nochroot
awk -f ${RPM_SOURCE_DIR}/postfix-chroot-setup.awk < conf/master.cf-nochroot > conf/master.cf

# APPLY OBLIGATORY PATCHES
%patch1 -p1 -b .config
%patch2 -p1 -b .chk
%patch3 -p1 -b .install

# APPLY OPTIONAL PATCHES

# Optionally apply Daniel Roesen's support patch for 250-AUTH= ESMTP banner
if [ "X$POSTFIX_BROKEN_AUTH" = "X1" ]; then
%patch97 -p1 -b .brokenauth
fi

# Optionally apply Daniel Roesen's safe mynetworks patch
if [ "X$POSTFIX_SAFE_MYNETWORKS" = "X1" ]; then
%patch98 -p1 -b .mynetworks
fi

# Optionally apply SMTPD Multiline greeting
if [ "X$POSTFIX_SMTPD_MULTILINE_GREETING" = "X1" ]; then
%patch99 -p1 -b .multiline
fi

# Copy README files allowing us to just go %doc below, and have rpm(1)
# automatically tuck it in alongside the READMEs and COPYRIGHTs.
cp ${RPM_SOURCE_DIR}/postfix-README_rpm.txt README_rpm.txt
cp ${RPM_SOURCE_DIR}/postfix-README_maildrop_security.txt \
	README_maildrop_security.txt

# create postfix user and group on BUILD machine if necessary

# Add the postfix group if not found
grep -q ^postfix: /etc/group || {
    groupadd -g %{gid} -r postfix || die \
            'gid collision, aborting install' \
	    'either add "postfix" group or delete the group using GID %{gid}'
    %whinge "Adding postfix to /etc/group."
}

# Add the postfix user if not found
grep -q ^postfix: /etc/passwd || {
    grep -q "^.*:.*:%{uid}:" /etc/passwd && die \
          'uid collision, aborting install' \
          'either add "postfix" user or delete the user using UID %{uid}'
    %whinge "Adding postfix to /etc/passwd."
    useradd -d %{queue_directory} -s /bin/true -g postfix -M -r -u %{uid} postfix
}

%build

umask 022
make tidy
make -f Makefile.init makefiles \
    'CCARGS=__POSTFIX_CCARGS__' \
    'AUXLIBS=__POSTFIX_AUXLIBS__'
make DEBUG="" OPT="$RPM_OPT_FLAGS"

%pre

# If the user "postfix" isn't in passwd, but the UID I like to use _is_, then
# don't try to find a free UID, just die.
die(){ %whinge "$*"; exit 1; }

# create postfix user and group on INSTALL machine if necessary

# Add the postfix group if not found
grep -q ^postfix: /etc/group || {
    groupadd -g %{gid} -r postfix || die \
            'gid collision, aborting install' \
	    'either add "postfix" group or delete the group using GID %{gid}'
    %whinge "Adding postfix to /etc/group."
}

# Add the postfix user if not found
grep -q ^postfix: /etc/passwd || {
    grep -q "^.*:.*:%{uid}:" /etc/passwd && die \
          'uid collision, aborting install' \
          'either add "postfix" user or delete the user using UID %{uid}'
    %whinge "Adding postfix to /etc/passwd."
    useradd -d %{queue_directory} -s /bin/true -g postfix -M -r -u %{uid} postfix
}


%install
umask 022
/bin/rm -rf ${RPM_BUILD_ROOT}
mkdir -p ${RPM_BUILD_ROOT}

strip -R .comment bin/* libexec/*

# WARNING: don't change the number of blank lines below - INSTALL.sh depends
# on it to work correctly
sh INSTALL.sh <<EOF 
${RPM_BUILD_ROOT}

%{config_directory}
%{daemon_directory}
%{command_directory}
%{queue_directory}
%{sendmail_path}
%{newaliases_path}
%{mailq_path}


%{_mandir}
EOF

# Change the default directory for alias_maps and alias_database
# to %{config_directory}
bin/postconf -c ${RPM_BUILD_ROOT}%{config_directory} -e \
	"alias_maps = hash:%{config_directory}/aliases" \
	"alias_database = hash:%{config_directory}/aliases" \
|| exit 1 

# This installs into the /etc/rc.d/init.d directory
mkdir -p ${RPM_BUILD_ROOT}%{init_directory}
install -c ${RPM_SOURCE_DIR}/postfix-etc-rc.d-init.d-postfix \
                  ${RPM_BUILD_ROOT}%{init_directory}/postfix

# Copy the Linux chroot setup script to %{config_directory} so
# we can use it to build the chroot environment during the install
cp examples/chroot-setup/LINUX2 \
		${RPM_BUILD_ROOT}%{config_directory}/chroot-setup-LINUX2
chmod u=rx ${RPM_BUILD_ROOT}%{config_directory}/chroot-setup-LINUX2

# This is the /etc/cron.daily directory
mkdir -p ${RPM_BUILD_ROOT}%{cron_directory}

install -c ${RPM_SOURCE_DIR}/postfix-etc-cron.daily-postfix ${RPM_BUILD_ROOT}%{cron_directory}/postfix
install -c auxiliary/rmail/rmail ${RPM_BUILD_ROOT}%{rmail_path}

#gzip -9f ${RPM_BUILD_ROOT}%{_mandir}/man{1,5,8}/* ||:

#
# copy new aliases files and generate a ghost aliases.db file
#
cp -f  ${RPM_SOURCE_DIR}/postfix-aliases ${RPM_BUILD_ROOT}%{config_directory}/aliases
chmod 644 ${RPM_BUILD_ROOT}%{config_directory}/aliases

touch ${RPM_BUILD_ROOT}/%{config_directory}/aliases.db


##############################################################################
# The post script executes after the package has been installed.  Here
# we put things that invoke files we just installed, and populate the
# directories we've created with local-dependent files.
%post

umask 022

/sbin/chkconfig --add postfix

# setup missing directory structures
%{command_directory}/postfix check

# this is the correct place to build the alias.db file
%{command_directory}/postalias %{config_directory}/aliases

# setup chroot structure
%{config_directory}/chroot-setup-LINUX2

%preun
umask 022

if [ "$1" = 0 ]; then
    # stop postfix silently if it's running
    %{daemon_directory}/master -t 2>/dev/null || {
        echo "Stopping the Postfix mail system"
        kill `sed 1q %{queue_directory}/pid/master.pid`
    }

    /sbin/chkconfig --del postfix                    

    # userdel also deletes the user's group
    userdel postfix || : %whinge "WARNING: failed to remove user postfix"

    # safety check
    test "%{queue_directory}Z" = "Z" && echo "WARNING: chroot removal buggy - check .spec file" && exit 0

    # cd to %{queue_directory} before removing unwanted files
    cd %{queue_directory} && {

        # remove chroot jail when uninstalling the package
        for i in etc/localtime usr/lib/zoneinfo/localtime \
		etc/host.conf etc/resolv.conf etc/nsswitch.conf \
		etc/hosts etc/passwd etc/services \
		lib/libnss_* lib/libresolv*; do
            test -f $i && rm -f $i
        done
        for dir in usr/lib/zoneinfo usr/lib usr lib etc; do
            test -d $i && rmdir $i
        done
        # selectively remove the rest of the queue directory structure
        # first remove the "queues" (and assume the hash depth is still 2)
	for dir in active bounce defer flush; do
	    for a in 0 1 2 3 4 5 6 7 8 9 A B C D E F; do
		test -d $dir/$a && {
		    for b in 0 1 2 3 4 5 6 7 8 9 A B C D E F; do
		        test -d $dir/$a/$b && (
		            rm -f $dir/$a/$b/*
		            rmdir $dir/$a/$b
		        )
		    done
		    rmdir $dir/$a
		}
	    done
	done
	# now remove the other directories
        for dir in corrupt deferred incoming maildrop pid private public saved; do
            test -d $dir && {
                rm -f $dir/*
                rmdir $dir || echo "unable to remove directory %{queue_directory}/$dir"
            }
        done
    }
fi

%postun

if [ "$1" != 0 ]; then
    # restart postfix if it was running
    # -- need to fix this to stop during install and keep note of the state for use here ---
    # stop postfix silently if it's running
    %{daemon_directory}/master -t 2>/dev/null || {
        echo "Stopping   the Postfix mail system"
        kill `sed 1q %{queue_directory}/pid/master.pid` 
        sleep 2 # to give things time to stop
        %{daemon_directory}/master &
        echo "Restarting the Postfix mail system"
    }
fi

%clean
rm -rf ${RPM_BUILD_ROOT}


%files
%defattr(-, root, root)
%verify(not md5 size mtime) %config %dir %{config_directory}
%attr(0755, root, root) %config %{config_directory}/postfix-script
%attr(0644, root, root) %verify(not md5 size mtime) %config(noreplace) %{config_directory}/main.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config(noreplace) %{config_directory}/master.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config %{config_directory}/install.cf
%attr(0644, root, root) %verify(not md5 size mtime) %config(noreplace) %{config_directory}/aliases
%attr(0644, root, root) %verify(not md5 size mtime) %ghost             %{config_directory}/aliases.db

%attr(0755, root, root) %{init_directory}/postfix
%attr(-, postfix, root) %verify(not md5 size mtime) %{queue_directory}
%attr(0755, root, root) %{cron_directory}/postfix

%doc 0README
%doc BEWARE
%doc COMPATIBILITY
%doc DEBUG_README
%doc ETRN_README
%doc FILTER_README
%doc HISTORY
%doc INSTALL
%doc INSTALL.sh
%doc LDAP_README
%doc LICENSE
%doc LMTP_README
%doc MACOSX_README
%doc MYSQL_README
%doc PCRE_README
%doc PORTING
%doc RELEASE_NOTES
%doc RESTRICTION_CLASS
%doc SASL_README 
%doc TODO
%doc ULTRIX_README
%doc UUCP_README

%doc README_rpm.txt README_maildrop_security.txt

%doc conf
%doc html

%{config_directory}/chroot-setup-LINUX2

%{daemon_directory}/bounce
%{daemon_directory}/cleanup
%{daemon_directory}/error
%{daemon_directory}/flush
%{daemon_directory}/lmtp
%{daemon_directory}/local
%{daemon_directory}/master
%{daemon_directory}/nqmgr
%{daemon_directory}/pickup
%{daemon_directory}/pipe
%{daemon_directory}/qmgr
%{daemon_directory}/showq
%{daemon_directory}/smtp
%{daemon_directory}/smtpd
%{daemon_directory}/spawn
%{daemon_directory}/trivial-rewrite

%{command_directory}/postalias
%{command_directory}/postcat
%{command_directory}/postconf
%{command_directory}/postdrop
%{command_directory}/postfix
%{command_directory}/postkick
%{command_directory}/postlock
%{command_directory}/postlog
%{command_directory}/postmap
%{command_directory}/postsuper

%{command_directory}/smtp-sink
%{command_directory}/smtp-source

%{sendmail_path}
%{mailq_path}
%{newaliases_path}
%attr(0755, root, root) %{rmail_path}

%{_mandir}/*/*

##############################################################################
# List of changes made to this package.
#
# Old changelog from Tue Dec 15 1998 - Dec 31 1999 has been removed.
#
# This included changes and suggestions from:
#
#	Lars Hecking <lhecking@nmrc.ucc.ie> 
#	John A. Martin <jam@jamux.com>
#	Chuck Mead <chuck@moongroup.com>
#	Simon J Mudd <sjmudd@pobox.com>
#	Matt Shibla <mshibla@iname.com>
#	Bennett Todd <bet@mordor.net>
#       Tim Powers <timp@redhat.com>

%changelog
* Thu Jan 04 2001 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-7, minor touches

* Mon Dec 31 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-6, suggestions from Daniel Roesen <droesen@entire-systems.com>
- remove default LDAP support: RedHat only supports this by default on RH 6.2
  and later
- remove package build after building spec file (I was being lazy)
- fix a couple of typos
- warn if user is trying to build the package when he is not the superuser

* Fri Dec 22 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-5
- include Requires: /etc/init.d if built on rh7
- change POSTFIX_SMTPD_MULTILINE to POSTFIX_SMTPD_MULTILINE_GREETING

* Fri Dec 22 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-3, support for rh7 building
  - if built on a rh7 machine, the spec file will include a Requires:
    for db3/db3-devel.
  - include the Requires: and BuildRequires: support for use with
    openldap, mysql, pcre, and cyrus-sasl packages
  ( current build also shows the version of redhat the spec file
    was generated on, just to make things a bit clearer )

* Fri Dec 22 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-2, major changes so that I
  can build any spec file to include mysql, ldap, pcre
  and AUTH support.  This is not finished but basically
  just requires the Requires: lines to work properly.
- add Broken auth support Daniel Roesen <droesen@entire-systems.com>

* Mon Dec 18 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001217-1, no changes, updating to latest snapshot

* Thu Dec 13 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001212-3, minor fixes
  %{queue_directory} removal while correct as probably a bit dangerous
  so try and be a bit safer.
  stop gzipping the man pages (I think this is done automatically now)

* Thu Dec 13 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001212-2, minor fixes
  %{queue_directory} removal wasn't correct

* Wed Dec 13 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001212-1, several changes following comments from
  Daniel Roesen <droesen@entire-systems.com>
  Tuomo Soini <tis@foobar.fi>
  - change chroot removal on package uninstallation
  - rebuild aliases.db on package installation not build
  - tidy up stop/start over package upgrade
  - change method for selectively installing patches
      now use POSTFIX_SMTPD_MULTILINE=1 for smtpd multiline greetings
              POSTFIX_SAFE_MYNETWORKS=1 for droeson's patch
  - create postfix user/group on package build if necessary
  - include smtp-source/smtp-sink for testing
  - include comments in spec file for building with other libraries
      this is so later I can do this automatically

* Thu Nov 23 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001121-4, several minor fixes following comments from
  Daniel Roesen <droesen@entire-systems.com>
  1. fix /etc/cron.daily/postfix
  2. remove /etc/postfix/aliases.db %ghost attribute
     (trying to remove error messages related to file not existing, I think
      that this is due to it not being copied over)
  3. trying to cure the uninstall complaining about files left over in 
     /var/spool/postfix
  4. remove groupdel which is not required after userdel on uninstall

* Thu Nov 23 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001121-3,
  fix minor error in chroot jail removal

* Thu Nov 23 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001121-2,
  didn't like chroot jail setup in -1, so now I use the example script
  to build the jail on package installation

- snapshot-20001121-1, makedefs should be fixed (but can't check)
  chroot jail now built on postfix start (from /etc/rc.d/init.d/postfix)
  change invocation of INSTALL.sh when installing into ${BUILD_ROOT}

* Tue Nov 07 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001030-2, add chkconfig postfix to /etc/cron.daily/postfix
  fix Wietse's makedefs so this builds on rh6.x and rh7.
  checked with Patrick Reich <dminor@adelade.org>

* Wed Nov 01 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001030-1, need to refix patch for RedHat 7 which 
  I don't yet have installed on my machine.

* Fri Oct 27 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-6, include patch so will build on RedHat 7,
  provided by Jim Drash <jdrash@one.net>
                    
* Sat Oct 14 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-5, include lmtp, nqmgr, spawn in %files section

* Thu Oct 12 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-4, fix chroot awk script which was wrong

* Thu Oct 12 2000 Simon Mudd <sjmudd@pobox.com>
- snapshot-20001005-3, changes url shown for my packages.

* Sun Oct 08 2000 Simon Mudd <sjmudd@pobox.com>
- built for snapshot-20001005-2, tidying up and taking in _some_
  of the stuff I've seen on one of redhat's postfix spec files.
  Also corrected the multiline patch.

* Sun Jun 04 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl08

* Sun Apr 15 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl07

* Fri Mar 30 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl06

* Fri Mar 10 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl05

* Tue Feb 01 2000 Simon Mudd <sjmudd@pobox.com>
- include the patch which optionally delays check_msg_size()

* Mon Jan 31 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl04

* Fri Jan 28 2000 Simon Mudd <sjmudd@pobox.com>
- built for postfix-19991231-pl03
- add warning option (which is not enabled by default on standard postfix
  config)
- add comments of possible builders of binary s390 and alpha packages

* Thu Jan 13 2000 Tim Powers <timp@redhat.com>
- removing the whinge stuff from the pre and post sections to meet Red Hat
	policy
- quiet setup 
- built for Powertools 6.2

* Thu Jan 13 2000 Simon Mudd <sjmudd@pobox.com>
- fix the postalias command which needed the '-c' option
  specified.  (Edward S. Marshall <emarshal@logic.net>)

- fix the rpm-3.x problem with defines not being commented out
  and comment that part of the spec file so that I don't get
  caught again. (It works on my platform with rpm-2.x!)

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- update to work with postfix-19991231-pl02

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- update to work with postfix-19991231-pl01
- and the ghost parameter for aliases.db

* Tue Jan 04 2000 Simon Mudd <sjmudd@pobox.com>
- Fix BEWARE problem in doc
- change man page compression to work on required files

